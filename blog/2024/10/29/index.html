<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">1BRC Challenge | DG</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://your-docusaurus-site.example.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://your-docusaurus-site.example.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://your-docusaurus-site.example.com/blog/2024/10/29/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="1BRC Challenge | DG"><meta data-rh="true" name="description" content="One thing that recently got nerd the hell out of me was 1 billion row challenge. Citing the original site:"><meta data-rh="true" property="og:description" content="One thing that recently got nerd the hell out of me was 1 billion row challenge. Citing the original site:"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-10-29T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="java,optimization"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://your-docusaurus-site.example.com/blog/2024/10/29/"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/blog/2024/10/29/" hreflang="en"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/blog/2024/10/29/" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://your-docusaurus-site.example.com/blog/2024/10/29/","mainEntityOfPage":"https://your-docusaurus-site.example.com/blog/2024/10/29/","url":"https://your-docusaurus-site.example.com/blog/2024/10/29/","headline":"1BRC Challenge","name":"1BRC Challenge","description":"One thing that recently got nerd the hell out of me was 1 billion row challenge. Citing the original site:","datePublished":"2024-10-29T00:00:00.000Z","author":[],"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://your-docusaurus-site.example.com/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="DG RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="DG Atom Feed"><link rel="stylesheet" href="/assets/css/styles.06b657aa.css">
<script src="/assets/js/runtime~main.8488876f.js" defer="defer"></script>
<script src="/assets/js/main.b779d075.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"></a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025/03/9/">Semantic search for dynamically built queries in Java and CodeQL</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025/03/3/">Wring simple parser with Megaparsec in Haskell</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025/01/18/">Introducing concurrency solver</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025/01/10/">My exploration of WASM/WASI</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/12/29/">Christmas with Quantum Mechanics</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/12/15/">Thoughts on observability</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/11/5/">Reflections after writing simple Spring Boot library</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/2024/10/29/">1BRC Challenge</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/10/26/">Topology graphs are important (and fun)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/10/4/">Writing own Kubernetes operator in Java</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">1BRC Challenge</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-10-29T00:00:00.000Z">October 29, 2024</time> · <!-- -->12 min read</div></header><div id="__blog-post-container" class="markdown"><p>One thing that recently got nerd the hell out of me was 1 billion row challenge. Citing the original site:</p>
<p><em>Your mission, should you decide to accept it, is deceptively simple: write a Java program for retrieving temperature measurement values from a text file and calculating the min, mean, and max temperature per weather station. There’s just one caveat: the file has 1,000,000,000 rows!</em></p>
<p>I was working on it after hourse and 1 week after taking on the challenge there are several conclusions worth writing about.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="baseline">Baseline<a href="#baseline" class="hash-link" aria-label="Direct link to Baseline" title="Direct link to Baseline">​</a></h2>
<p>To make dev loop faster I decided limit the task to 100 million rows.</p>
<p>The baseline from the autor was an idiomatic streams, but single threaded.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class CalculateAverage_baseline {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final String FILE = &quot;./measurements.txt&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static record Measurement(String station, double value) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private Measurement(String[] parts) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this(parts[0], Double.parseDouble(parts[1]));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static record ResultRow(double min, double mean, double max) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String toString() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return round(min) + &quot;/&quot; + round(mean) + &quot;/&quot; + round(max);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private double round(double value) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Math.round(value * 10.0) / 10.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static class MeasurementAggregator {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private double min = Double.POSITIVE_INFINITY;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private double max = Double.NEGATIVE_INFINITY;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private double sum;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private long count;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collector&lt;Measurement, MeasurementAggregator, ResultRow&gt; collector = Collector.of(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                MeasurementAggregator::new,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                (a, m) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    a.min = Math.min(a.min, m.value);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    a.max = Math.max(a.max, m.value);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    a.sum += m.value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    a.count++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                (agg1, agg2) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    var res = new MeasurementAggregator();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    res.min = Math.min(agg1.min, agg2.min);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    res.max = Math.max(agg1.max, agg2.max);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    res.sum = agg1.sum + agg2.sum;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    res.count = agg1.count + agg2.count;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return res;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                agg -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return new ResultRow(agg.min, (Math.round(agg.sum * 10.0) / 10.0) / agg.count, agg.max);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, ResultRow&gt; measurements = new TreeMap&lt;&gt;(Files.lines(Paths.get(FILE))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(l -&gt; new Measurement(l.split(&quot;;&quot;)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(groupingBy(m -&gt; m.station(), collector)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(measurements);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The performance is not good as expected:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">time ./calculate_average_baseline.sh </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">real    0m15,846s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user    0m16,002s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys     0m0,769s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="parallelizing-the-code">Parallelizing the code<a href="#parallelizing-the-code" class="hash-link" aria-label="Direct link to Parallelizing the code" title="Direct link to Parallelizing the code">​</a></h2>
<p>My first thought was to parallelize the code and see how fast it will run. Obvious choice is to use streams the same way but add .parallel() call. So updates go to central HashMap and access has to be synchronized.</p>
<p>One way is to use locks, tried it and it was slow. Remembering we have 100 million rows locking on whole object is very wasteful. Much better would be to lock only on specific hashmap entry with given key.</p>
<p>What surprised me was that Atomic* primitives and spinlocks were actually slower than wait/notify. Luckly there is another way you can do same thing with ConcurrentHashMap. When calling compute method the run lambda will be synchronized.</p>
<p>So the code reads file on the fly and uses Spliterator to carve out overflow of work to another thread run on ForkJoinPool. Then each iteration of foreach does the update on ConcurrentHashMap.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class CalculateAverage_dg2 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final String FILE = &quot;./measurements.txt&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static class Measurement {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public double min = Double.MAX_VALUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public double max = Double.MIN_VALUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public double sum = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public double count = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public Measurement(double value) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.min = value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.max = value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.sum = value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.count = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String toString() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return round(min) + &quot;/&quot; + round(max) + &quot;/&quot; + round(sum / count);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConcurrentHashMap&lt;String, Measurement&gt; measurements = new ConcurrentHashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Files.lines(Path.of(FILE)).parallel().forEach(line -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int split = line.indexOf(&quot;;&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String key = line.substring(0, split);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            double val = Double.parseDouble(line.substring(split + 1));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            measurements.compute(key, (k, _v) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (_v == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return new Measurement(val);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                _v.min = Double.min(_v.min, val);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                _v.max = Double.max(_v.max, val);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                _v.sum += val;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                _v.count++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return _v;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var sorted = new TreeMap&lt;&gt;(measurements);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(sorted);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static double round(double value) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Math.round(value * 10.0) / 10.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The results were good - on 4 core (8 threads) CPU it runs 4 times faster:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">time ./calculate_average_dg2.sh </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">real    0m4,992s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user    0m33,384s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys     0m1,207s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Spliterators performance is good because of data locality that it preserves. Processors have limited amount of L1/L2/L3 caches so if you don&#x27;t keep the data close to computation then this translates to cache missess. So best way is to perform operations &quot;semi-sequentially&quot; just like the spliterators.</p>
<p>But... Streams create threads dynamically and this means you can&#x27;t partition the data into well known parts. So the access has to be synchronized in one place and this one big problem here.</p>
<p>It would be the end of the story if I didn&#x27;t check the leaderboard on competitions github repo. There were speedups as fast as astonishing 32x times faster. So there is much to analyse. Below are the most important optimizations I tried in my playground.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="optimizations">Optimizations<a href="#optimizations" class="hash-link" aria-label="Direct link to Optimizations" title="Direct link to Optimizations">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="o1-reading-longs-instead-of-bytes">O1. Reading longs instead of bytes<a href="#o1-reading-longs-instead-of-bytes" class="hash-link" aria-label="Direct link to O1. Reading longs instead of bytes" title="Direct link to O1. Reading longs instead of bytes">​</a></h3>
<p>You may recall that everything is represented in JVM as an int. This means that even a byte is in fact and 4-byte int. I&#x27;m not sure if JVM doesn&#x27;t do some kind of compression of byte[] array. If not that would mean the data is actually 4x times larager. So it is wasteful to search newline byte by byte. The trick is to load 8 bytes at once and find newline in whole batch.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> long word = buffer.getLong();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">long match = word ^ 0x0a0a0a0a0a0a0a0aL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">long line = (match - 0x0101010101010101L) &amp; (~match &amp; 0x8080808080808080L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (line == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    i += 8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">next = i + (Long.numberOfTrailingZeros(line) &gt;&gt;&gt; 3) + 1;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Xor will zero the byte that has newline (0x0a). Then we cause underflow which sets leading bit to 1. And then we zero out everthing else. From the leading bit we can get offset of newline in 8-byte pack.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="o2-represent-measurements-as-int--skip-parsing">O2. Represent measurements as int / skip parsing<a href="#o2-represent-measurements-as-int--skip-parsing" class="hash-link" aria-label="Direct link to O2. Represent measurements as int / skip parsing" title="Direct link to O2. Represent measurements as int / skip parsing">​</a></h3>
<p>We can take advantage of the data format: floats have only one decimal point and temperatures are not greater or lesser than 100 points for sure. So the idea is to parse the number manually and multiply it by 10 so that it is the integer.</p>
<p>This is not huge improvement but still. Actually big improvement is skipping Double.parseDouble as we can discard uncessary complexity like long mantissa and exponent part.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="o3-defer-creating-of-string">O3. Defer creating of String<a href="#o3-defer-creating-of-string" class="hash-link" aria-label="Direct link to O3. Defer creating of String" title="Direct link to O3. Defer creating of String">​</a></h3>
<p>Strings are a little bit heavy because they are not underlied by byte[] but char[]. So each time we create a string we encode it and according to the charset. We can defer creating strings until they are needed for printing. But we have to find some other key for the hashmap.</p>
<p>Copying byte array is much faster and this is what I used.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="o4-faster-hashes">O4. Faster hashes<a href="#o4-faster-hashes" class="hash-link" aria-label="Direct link to O4. Faster hashes" title="Direct link to O4. Faster hashes">​</a></h3>
<p>Faster non-cryptographic hash is needed. One suitable algorithm for this task is FNV. It is simple enought to implement and run fast.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public int hashCode() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    long hash = 0x811C9DC5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    long prime = 0x01000193;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (byte b : bytes) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hash = hash ^ b;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hash *= prime;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return (int) hash;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="o5-skipping-synchronization">O5. Skipping synchronization<a href="#o5-skipping-synchronization" class="hash-link" aria-label="Direct link to O5. Skipping synchronization" title="Direct link to O5. Skipping synchronization">​</a></h3>
<p>With such huge load synchronization is too slow. It is fine from more coarse grained control flow, but 100 million is just too much. So optimization is to use separate threads each with separate hashmap. Then merge hashmaps after the work is done. As number of hashmaps will be several orders of magnitude less than rows then merging time will be negligible.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="o6-off-heap-memory">O6. Off heap memory<a href="#o6-off-heap-memory" class="hash-link" aria-label="Direct link to O6. Off heap memory" title="Direct link to O6. Off heap memory">​</a></h3>
<p>We could use Unsafe to skip array bounds checking for example. But much better way is avoid allocating data on the heap alltogether. With mapping file chunks directly to memory we can easily achieve that. We get MemorySegment and invoke methods which are &quot;native&quot; to get fast access.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="07-aligning-array-address-to-the-multitude-of-8-bytes">07. Aligning array address to the multitude of 8 bytes<a href="#07-aligning-array-address-to-the-multitude-of-8-bytes" class="hash-link" aria-label="Direct link to 07. Aligning array address to the multitude of 8 bytes" title="Direct link to 07. Aligning array address to the multitude of 8 bytes">​</a></h3>
<p>There is performance penalty for accessing unaligned data, which has to be padded either way. So we can remap all the data in segment once and then enjoy the benefits of reading values in multitudes of 8-bytes (longs).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="final-version">Final version<a href="#final-version" class="hash-link" aria-label="Direct link to Final version" title="Direct link to Final version">​</a></h3>
<p>The final version uses all above techniques and gets decent peformance. The file is split into 100MB chunks which are memory mapped by each thread. They are executed in form of ForkJoinPool task and run on common pool which has concurrency level same as numer of threads.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">class Measurement {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int min = Integer.MAX_VALUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int max = Integer.MIN_VALUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int sum = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int count = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Measurement(int value) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.min = value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.max = value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.sum = value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.count = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String toString() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return round(min / 10.0) + &quot;/&quot; + round(max / 10.0) + &quot;/&quot; + round((sum / 10.0) / count);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static double round(double value) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Math.round(value * 10.0) / 10.0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class FastKey implements Comparable&lt;FastKey&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private byte[] bytes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int hash;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Charset charset = Charset.forName(&quot;UTF-8&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public FastKey(MemorySegment segment) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bytes = segment.toArray(ValueLayout.OfByte.JAVA_BYTE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long hash = 0x811C9DC5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long prime = 0x01000193;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (byte b : bytes) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            hash = hash ^ b;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            hash *= prime;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.hash = (int) hash;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int hashCode() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return this.hash;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean equals(Object obj) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (obj == this) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!(obj instanceof FastKey)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Arrays.equals(bytes, ((FastKey) obj).bytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int compareTo(FastKey o) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Arrays.compare(bytes, o.bytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String toString() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new String(bytes, charset);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class ComputeMeasurementsPartTask implements Callable&lt;Map&lt;FastKey, Measurement&gt;&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int start;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int end;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Charset charset = Charset.forName(&quot;UTF-8&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private MemorySegment segment;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private byte getByte(int index) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return segment.get(ValueLayout.OfByte.JAVA_BYTE, index);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long getLong(int index) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return segment.get(ValueLayout.OfLong.JAVA_LONG, index);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ComputeMeasurementsPartTask(int start, int end, int limit, FileChannel channel) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.segment = channel.map(FileChannel.MapMode.READ_ONLY, start, limit - start, Arena.global());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int s = start, s2 = start, e = end;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (s != 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (getByte(s - s2) != 0x0a) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                s++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            s++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (e &lt; limit &amp;&amp; getByte(e - s2) != 0x0a) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int prefix = s % 8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MemorySegment padded = Arena.global().allocate(e - s + prefix);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        padded.asSlice(prefix).copyFrom(segment.asSlice(s - s2, e - s));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.segment = padded;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.start = prefix;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.end = e - s + prefix;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void doActualWork(int start, int end, Map&lt;FastKey, Measurement&gt; measurements) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int splitIndex = start;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (getByte(splitIndex) != 0x3b) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            splitIndex++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var key = new FastKey(segment.asSlice(start, splitIndex - start));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean negative = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int ind = splitIndex + 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (getByte(ind) == (byte) &#x27;-&#x27;) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            negative = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ind++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int v = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (end - ind == 4) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            v = v * 10 + getByte(ind++) - &#x27;0&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            v = v * 10 + getByte(ind++) - &#x27;0&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ind++; // &#x27;.&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            v = v * 10 + getByte(ind) - &#x27;0&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            v = getByte(ind++) - &#x27;0&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ind++; // &#x27;.&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            v = v * 10 + getByte(ind) - &#x27;0&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int val = negative ? -v : v;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var _v = measurements.get(key);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (_v != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (val &lt; _v.min) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                _v.min = val;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (val &gt; _v.max) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                _v.max = val;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _v.sum += val;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _v.count++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            measurements.put(key, new Measurement(val));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Map&lt;FastKey, Measurement&gt; call() throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var measurements = new HashMap&lt;FastKey, Measurement&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int prev = start;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; end; i += 8) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (i + 8 &lt; end) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                long word = getLong(i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                long match = word ^ 0x0a0a0a0a0a0a0a0aL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                long line = (match - 0x0101010101010101L) &amp; (~match &amp; 0x8080808080808080L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (line == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    i += 8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    continue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                int next = i + (Long.numberOfTrailingZeros(line) &gt;&gt;&gt; 3);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                doActualWork(prev, next, measurements);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                prev = next + 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                doActualWork(prev, end, measurements);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return measurements;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CalculateAverage_dg {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static final String FILE = &quot;./measurements.txt&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        FileChannel channel = FileChannel.open(Path.of(CalculateAverage_dg.FILE), StandardOpenOption.READ);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var parts = new ArrayList&lt;Map&lt;FastKey, Measurement&gt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var futures = new ArrayList&lt;Future&lt;Map&lt;FastKey, Measurement&gt;&gt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int fileSize = (int) Files.size(Path.of(FILE));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int chunkSize = 20 * 1024 * 1024;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int noOfThreads = fileSize / chunkSize;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; noOfThreads; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int start = i * chunkSize;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int end = Math.min((i + 1) * chunkSize, fileSize);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            int limit = Math.min((i + 1) * chunkSize + 1024, fileSize);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            var task = new ComputeMeasurementsPartTask(start, end, limit, channel);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            futures.add(ForkJoinPool.commonPool().submit(task));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (var future : futures) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            parts.add(future.get());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var measurements = parts.stream().flatMap(map -&gt; map.entrySet().stream())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        Collectors.toMap(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                Map.Entry::getKey,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                Map.Entry::getValue,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                (e1, e2) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    e1.min = Integer.min(e1.min, e2.min);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    e1.max = Integer.max(e1.max, e2.max);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    e1.sum += e2.sum;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    e1.count += e2.count;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    return e1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                }));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var sorted = new TreeMap&lt;&gt;(measurements);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(sorted);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The time is impressive:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">time ./calculate_average_dg.sh </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">real    0m1,465s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user    0m8,505s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys     0m0,526s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>For comparison this is the time of top solution from the leaderboard.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">time ./calculate_average_thomaswue.sh </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">real    0m0,794s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user    0m5,032s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys     0m0,199s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So it is &quot;only&quot; two times slower than the best. I don&#x27;t know how would that translate to the leaderboard. But this guy is actually founder of GraalVM so he definitely knows what he is doing.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<ul>
<li>ConcurrentHashMap is suprisingly fast, without good background it would be hard to write something faster</li>
<li>Off-heap memory gives considerable performance boost</li>
<li>Reading file as longs is a nice trick that I didn&#x27;t know up to date</li>
</ul></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/java">java</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/optimization">optimization</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2024-10-29.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/2024/11/5/"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">Reflections after writing simple Spring Boot library</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/2024/10/26/"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Topology graphs are important (and fun)</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#baseline" class="table-of-contents__link toc-highlight">Baseline</a></li><li><a href="#parallelizing-the-code" class="table-of-contents__link toc-highlight">Parallelizing the code</a></li><li><a href="#optimizations" class="table-of-contents__link toc-highlight">Optimizations</a><ul><li><a href="#o1-reading-longs-instead-of-bytes" class="table-of-contents__link toc-highlight">O1. Reading longs instead of bytes</a></li><li><a href="#o2-represent-measurements-as-int--skip-parsing" class="table-of-contents__link toc-highlight">O2. Represent measurements as int / skip parsing</a></li><li><a href="#o3-defer-creating-of-string" class="table-of-contents__link toc-highlight">O3. Defer creating of String</a></li><li><a href="#o4-faster-hashes" class="table-of-contents__link toc-highlight">O4. Faster hashes</a></li><li><a href="#o5-skipping-synchronization" class="table-of-contents__link toc-highlight">O5. Skipping synchronization</a></li><li><a href="#o6-off-heap-memory" class="table-of-contents__link toc-highlight">O6. Off heap memory</a></li><li><a href="#07-aligning-array-address-to-the-multitude-of-8-bytes" class="table-of-contents__link toc-highlight">07. Aligning array address to the multitude of 8 bytes</a></li><li><a href="#final-version" class="table-of-contents__link toc-highlight">Final version</a></li></ul></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"></div></footer></div>
</body>
</html>