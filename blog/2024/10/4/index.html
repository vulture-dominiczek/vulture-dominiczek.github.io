<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Writing own Kubernetes operator in Java | DG</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://your-docusaurus-site.example.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://your-docusaurus-site.example.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://your-docusaurus-site.example.com/blog/2024/10/4/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Writing own Kubernetes operator in Java | DG"><meta data-rh="true" name="description" content="Operators introduced by CoreOS in 2016 are now considered early majority on Categories of Adopters scale."><meta data-rh="true" property="og:description" content="Operators introduced by CoreOS in 2016 are now considered early majority on Categories of Adopters scale."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-10-04T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="k8s,java,devops"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://your-docusaurus-site.example.com/blog/2024/10/4/"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/blog/2024/10/4/" hreflang="en"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/blog/2024/10/4/" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://your-docusaurus-site.example.com/blog/2024/10/4/","mainEntityOfPage":"https://your-docusaurus-site.example.com/blog/2024/10/4/","url":"https://your-docusaurus-site.example.com/blog/2024/10/4/","headline":"Writing own Kubernetes operator in Java","name":"Writing own Kubernetes operator in Java","description":"Operators introduced by CoreOS in 2016 are now considered early majority on Categories of Adopters scale.","datePublished":"2024-10-04T00:00:00.000Z","author":[],"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://your-docusaurus-site.example.com/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="DG RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="DG Atom Feed"><link rel="stylesheet" href="/assets/css/styles.06b657aa.css">
<script src="/assets/js/runtime~main.8488876f.js" defer="defer"></script>
<script src="/assets/js/main.b779d075.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"></a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025/03/9/">Semantic search for dynamically built queries in Java and CodeQL</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025/03/3/">Wring simple parser with Megaparsec in Haskell</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025/01/18/">Introducing concurrency solver</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025/01/10/">My exploration of WASM/WASI</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/12/29/">Christmas with Quantum Mechanics</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/12/15/">Thoughts on observability</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/11/5/">Reflections after writing simple Spring Boot library</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/10/29/">1BRC Challenge</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/10/26/">Topology graphs are important (and fun)</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/2024/10/4/">Writing own Kubernetes operator in Java</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Writing own Kubernetes operator in Java</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-10-04T00:00:00.000Z">October 4, 2024</time> · <!-- -->6 min read</div></header><div id="__blog-post-container" class="markdown"><p>Operators introduced by <a href="https://www.redhat.com/en/blog/introducing-operators-putting-operational-knowledge-into-software" target="_blank" rel="noopener noreferrer">CoreOS</a> in 2016 are now considered early majority on Categories of Adopters scale.</p>
<p>It means that the technology is becoming pretty mainstream. They use Kubernetes Server API to enforce some operational patterns for a deployment of application. This way application developers can translate the &quot;domain&quot; knowledge to Kubernetes land.</p>
<p>I experimented with them lately, but not enough skills of Go discouraged me at first. But then I realised that I can try to write an Operator in my &quot;mother tonque&quot; - Java. In this post I will share couple of reflections on the topic.</p>
<p><strong>TLDR</strong> <a href="https://github.com/vulture-dominiczek/operator-hello-world" target="_blank" rel="noopener noreferrer">Here</a> is the hello world I wrote.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="anatomy-of-an-operator">Anatomy of an operator<a href="#anatomy-of-an-operator" class="hash-link" aria-label="Direct link to Anatomy of an operator" title="Direct link to Anatomy of an operator">​</a></h2>
<p>First and most important of all, <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/operator/" target="_blank" rel="noopener noreferrer">Operator</a> is an extension to Kubernetes. The core idea is to capture what human operator/admin would normally do and encode it in software.</p>
<p>At some point when Kubernetes was adopted by more and more users there occured an obvious need to extend it&#x27;s API. A <strong>resource</strong> in Kubernetes is an endpoint that groups several API objects. That is for example pods resource groups pods and allows actions like <strong>get, delete, patch</strong> and so on to be acted on them.</p>
<p>But operators are extension to the system so there must be a way to represent their objectives Kubernetes (declarative) proper way. And there is - <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" target="_blank" rel="noopener noreferrer">Custom Resources</a>.</p>
<p>Whenever you write a new Operator, you will want to create custom resource for it. As soon as you register your custom resouce in Kubernetes it will start to serve it from API Server and all actions like get, delete and others will be available. And then your Operator will monitor this new resource and take appropirate actions when desired.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="control-loop">Control loop<a href="#control-loop" class="hash-link" aria-label="Direct link to Control loop" title="Direct link to Control loop">​</a></h4>
<p>Demystification no. 1 is that Operators are nothing new. Kubernetes is driven internally by Controllers. From the definition they implement <strong>control loop</strong>.</p>
<p>Funny thing, the term is actually taken from robotics and it is <em>nonterminating loop that corrects the state of the system</em>. What does it mean? For example one simple controller could watch that the certain pod is present in system all the times. Whenever it detects that pod is down it will take steps to restart it and correct the &quot;glitch&quot;.</p>
<p>Now, operators are basically the same thing, but as a form of extension. Kubernetes is very permissive when it comes to it&#x27;s API. So as long as you can reach the Server API (and have rights) then you can do any thing with it. So here is the thing -- operator is a custom controller. But: when it boils down to it&#x27;s core -- it&#x27;s just a pod! Like any other. I mean you will probably want to add replication, leader election and so on, but this is still a piece of software with an access to Kubernetes API.</p>
<p><img decoding="async" loading="lazy" src="/assets/images/public_cloud-containers_orchestration-managed_kubernetes-installing-go-operator-images-operator-818e1c5c2f9f798bee5791f086521857.png" width="640" height="196" class="img_ev3q"></p>
<p>To sum up: operator watches events from the server (it can), or reads the status of current resources and matches that with whats specified in CRD. If there is a mismatch it does <strong>reconcillation</strong>. This is just another term for control loop. But outside Kubernetes core API.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-client-in-java">Kubernetes Client in Java<a href="#kubernetes-client-in-java" class="hash-link" aria-label="Direct link to Kubernetes Client in Java" title="Direct link to Kubernetes Client in Java">​</a></h4>
<p>Go to solution when dealing in Kubernetes in Java is Fabric8 client. You also want to watch this presentation.</p>
<p>You init the client very easily:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">KubernetesClient client = new KubernetesClientBuilder().build();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And then there is a matter of reading the api and ivoking appropirate methods:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var currentServingDeploymentNullable = client.apps().deployments().inNamespace(&quot;default&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .withName(&quot;web-serving-app-deployment&quot;).get();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">var currentServingDeployment = Optional.ofNullable(currentServingDeploymentNullable);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="informers">Informers<a href="#informers" class="hash-link" aria-label="Direct link to Informers" title="Direct link to Informers">​</a></h4>
<p>So, the basic idea is to forever run the control loop, sleep couple of seconds and do everthing again. But this is not the best way to do this. Ideally you would want to only do work when something changes. Actually you can do this easily as well.</p>
<p>Kubernetes has a notion of informers. These are WebSocket connections-subscriptions to changes of particular resources. So for example, you could watch all the pods in the namespace for changes and get informed when anything changes at all.</p>
<p>This leads to following solution - in the end of reconcillation block on the monitor:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private static Object changes = new Object();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">synchronized (changes) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    changes.wait();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Whenever something changes our informer will let us unblock the control loop:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var handler = new GenericResourceEventHandler&lt;&gt;(update -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    synchronized (changes) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        changes.notifyAll();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">crdClient.inform(handler).start();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The Callback is a little bit bloated so I abstracted it away like so:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class GenericResourceEventHandler&lt;T&gt; implements ResourceEventHandler&lt;T&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Consumer&lt;T&gt; handler;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public GenericResourceEventHandler(Consumer&lt;T&gt; handler) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.handler = handler;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onAdd(T obj) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.handler.accept(obj);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onUpdate(T oldObj, T newObj) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.handler.accept(newObj);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onDelete(T obj, boolean deletedFinalStateUnknown) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.handler.accept(null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="deployment">Deployment<a href="#deployment" class="hash-link" aria-label="Direct link to Deployment" title="Direct link to Deployment">​</a></h4>
<p>So when you are done with the implementation you will probably want to deploy the operator... I wrote it as the Spring Boot application and some interesting stuff happened on the way.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="tip-1">Tip 1<a href="#tip-1" class="hash-link" aria-label="Direct link to Tip 1" title="Direct link to Tip 1">​</a></h4>
<p>You will want to have a private repository, and I chose GHCR. You can set it up and download the passcode. Then create secret for kubernetes:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl create secret docker-registry regcred \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --docker-server=ghcr.io \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --docker-username=dgawlik \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --docker-password=$GITHUB_TOKEN</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="tip-2">Tip 2<a href="#tip-2" class="hash-link" aria-label="Direct link to Tip 2" title="Direct link to Tip 2">​</a></h4>
<p>You have to create CRD of course. Actually fabric8 client got you covered:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> &lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;groupId&gt;io.fabric8&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;artifactId&gt;kubernetes-client&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;version&gt;6.13.4&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;dependency&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;groupId&gt;io.fabric8&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;artifactId&gt;crd-generator-apt&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;version&gt;6.13.4&lt;/version&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;scope&gt;provided&lt;/scope&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/dependency&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Whenever you create CRD classes it will generate the CRD manifest so you can kubectl apply it. So for example:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Group(&quot;com.github.webserving&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Version(&quot;v1alpha1&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ShortNames(&quot;websrv&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class WebServingResource extends CustomResource&lt;WebServingSpec, WebServingStatus&gt; implements Namespaced {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public record WebServingSpec(String page1, String page2) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public record WebServingStatus (String status) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="tip-3">Tip 3<a href="#tip-3" class="hash-link" aria-label="Direct link to Tip 3" title="Direct link to Tip 3">​</a></h4>
<p>You will want to create native images with GraalVm to speed things up. If you don&#x27;t have a lot of memory then you can tradeoff the quality of binary for building time/resources.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;build&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;plugins&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;plugin&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.graalvm.buildtools&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;native-maven-plugin&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;configuration&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;buildArgs&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;buildArg&gt;-Ob&lt;/buildArg&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;/buildArgs&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;/configuration&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/plugin&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;plugin&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;configuration&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;image&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;publish&gt;true&lt;/publish&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;builder&gt;paketobuildpacks/builder-jammy-full:latest&lt;/builder&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;name&gt;ghcr.io/dgawlik/webpage-serving:1.0.5&lt;/name&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;env&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &lt;BP_JVM_VERSION&gt;21&lt;/BP_JVM_VERSION&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;/env&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;/image&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;docker&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;publishRegistry&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &lt;url&gt;https://ghcr.io/dgawlik&lt;/url&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &lt;username&gt;dgawlik&lt;/username&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &lt;password&gt;${env.GITHUB_TOKEN}&lt;/password&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    &lt;/publishRegistry&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &lt;/docker&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;/configuration&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/plugin&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &lt;/plugins&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&lt;/build&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And second when you set publish property to true, the package step will automatically push the image to your repositry.</p>
<p>The third - you pass -Ob parameter to GraalVM. This will insturct the runtime to do fastest, cheapest build possible. And of course - BP_JVM_VERSION has to be java of your project or things will not work.</p>
<p>And last thing -- if you want debug the container, you will have to choose paketobuildpacks/builder-jammy-full<!-- -->:latest<!-- --> as other buildpacks don&#x27;t include shell (shame).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>I haven&#x27;t covered everything, but everything else is in the repo. The repo is proof of concept that operators in Java are not complicated at all. I would say that even they are easier than in Go. So in the repo you will find following:</p>
<ul>
<li>spring-boot static server</li>
<li>operator that watches CRD and mounts config maps in server so that it can serve the websites from the CRD</li>
</ul>
<p>So this basically is Operator hello world.</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/k-8-s">k8s</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/java">java</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/devops">devops</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2024-10-4.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/2024/10/26/"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">Topology graphs are important (and fun)</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#anatomy-of-an-operator" class="table-of-contents__link toc-highlight">Anatomy of an operator</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"></div></footer></div>
</body>
</html>