<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Semantic search for dynamically built queries in Java and CodeQL | DG</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://your-docusaurus-site.example.com/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://your-docusaurus-site.example.com/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://your-docusaurus-site.example.com/blog/2025/03/9/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Semantic search for dynamically built queries in Java and CodeQL | DG"><meta data-rh="true" name="description" content="There was a challenge for me recently to search for SQL queries in large codebase. There is a problem"><meta data-rh="true" property="og:description" content="There was a challenge for me recently to search for SQL queries in large codebase. There is a problem"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2025-03-09T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="codeql,java,sql"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://your-docusaurus-site.example.com/blog/2025/03/9/"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/blog/2025/03/9/" hreflang="en"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/blog/2025/03/9/" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://your-docusaurus-site.example.com/blog/2025/03/9/","mainEntityOfPage":"https://your-docusaurus-site.example.com/blog/2025/03/9/","url":"https://your-docusaurus-site.example.com/blog/2025/03/9/","headline":"Semantic search for dynamically built queries in Java and CodeQL","name":"Semantic search for dynamically built queries in Java and CodeQL","description":"There was a challenge for me recently to search for SQL queries in large codebase. There is a problem","datePublished":"2025-03-09T00:00:00.000Z","author":[],"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://your-docusaurus-site.example.com/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="DG RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="DG Atom Feed"><link rel="stylesheet" href="/assets/css/styles.06b657aa.css">
<script src="/assets/js/runtime~main.8488876f.js" defer="defer"></script>
<script src="/assets/js/main.b779d075.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><a class="navbar__brand" href="/"></a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/2025/03/9/">Semantic search for dynamically built queries in Java and CodeQL</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025/03/3/">Wring simple parser with Megaparsec in Haskell</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025/01/18/">Introducing concurrency solver</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025/01/10/">My exploration of WASM/WASI</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/12/29/">Christmas with Quantum Mechanics</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/12/15/">Thoughts on observability</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/11/5/">Reflections after writing simple Spring Boot library</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/10/29/">1BRC Challenge</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/10/26/">Topology graphs are important (and fun)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2024/10/4/">Writing own Kubernetes operator in Java</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Semantic search for dynamically built queries in Java and CodeQL</h1><div class="container_mt6G margin-vert--md"><time datetime="2025-03-09T00:00:00.000Z">March 9, 2025</time> Â· <!-- -->7 min read</div></header><div id="__blog-post-container" class="markdown"><p>There was a challenge for me recently to search for SQL queries in large codebase. There is a problem
with using basic grep or even IntelliJ search here because of the performance issues.</p>
<ul>
<li>queries are long and dynamically appended</li>
<li>codebase is large</li>
<li>string searching is not performant enough.</li>
</ul>
<p>An answer how to solve this task is buried in history of beginnings of static analysis tools. The first tools
used basic regexes, but that turned out inefficient pretty quickly. Then incrementally more focus has been
put to parse source files to Abstract Syntax Trees which is allows more freedom to write queries. Then
finally Data Flow approach was added alongside Taint Analysis to make current landscape of security today.</p>
<p>Semantic searching has 2 advantages:</p>
<ul>
<li>searching bare tokens is orders of magnitude faster than strings, in turn searching Abstract Syntax Trees
is order of magnitude faster than tokens</li>
<li>semantic search offers more precision in designing the queries which only reinforces the first point.</li>
</ul>
<p><strong>CodeQL</strong> is one such tool that knows the syntax of major languages (Java) and caters for performant search of
large codebases. I decided to have fun with it over the weekend and push it to it&#x27;s limits as searching for
dynamic queries is hard enough. I will show how to set up the project and write some queries for toy source file.</p>
<p>Let&#x27;s get started.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="codeql-setup">CodeQL setup<a href="#codeql-setup" class="hash-link" aria-label="Direct link to CodeQL setup" title="Direct link to CodeQL setup">â</a></h2>
<p>First step is downloading <a href="https://docs.github.com/en/code-security/codeql-cli/getting-started-with-the-codeql-cli/setting-up-the-codeql-cli" target="_blank" rel="noopener noreferrer">CLI</a> and setting it up in a PATH.</p>
<p>Then you have to build <strong>database</strong> for the project you will be analyzing. Unfortunately on each code change you have to rebuid it.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">codeql database create --source-root=. --language=java-kotlin --command=&#x27;./mvnw clean compile&#x27; -- tester</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>--source-root</code> - it is used for reporting in queries which give you source locations</p>
<p><code>--language</code> - if you want to limit project just to one language, this is an option</p>
<p><code>--command</code> - codeQL tracks work of build tool to extract AST and DataFlow information</p>
<p>Then in next step download VSCode extension.</p>
<p>Select <strong>QL</strong> on the sidebar.</p>
<p>Lanugage &gt; set Java.</p>
<p>Databases &gt; From a folder &gt; point to database folder you have built.</p>
<p>Ctrl+Shift+p &gt; CodeQL: create query</p>
<p>And you are good to go.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-challenge">The challenge<a href="#the-challenge" class="hash-link" aria-label="Direct link to The challenge" title="Direct link to The challenge">â</a></h2>
<p>We will be operating on Spring Boot project, but of interest is one file only really.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package com.example.demo.database;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.beans.factory.annotation.Autowired;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.jdbc.core.JdbcTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.stereotype.Service;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.example.demo.valueobject.Purchasing1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class WWRepository1 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   private JdbcTemplate jdbcTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   public List&lt;Purchasing1&gt; getAllPurchasing() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StringBuilder aside = new StringBuilder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        aside.append(&quot;Hello &quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        aside.append(&quot;World&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        aside.append(&quot;!&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(aside.toString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        StringBuilder sql = new StringBuilder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sql.append(&quot;SELECT Description, SupplierName, BankAccountName, ValidFrom, ValidTo &quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sql.append(&quot;FROM Purchasing.PurchaseOrders o &quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addJoin1(sql);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        addJoin2(sql);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return jdbcTemplate.query(sql.toString(), (rs, rowNum) -&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             new Purchasing1(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                rs.getString(&quot;Description&quot;), </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                rs.getString(&quot;SupplierName&quot;), </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                rs.getString(&quot;BankAccountName&quot;), </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                rs.getTimestamp(&quot;ValidFrom&quot;).toLocalDateTime(), </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                rs.getTimestamp(&quot;ValidTo&quot;).toLocalDateTime()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   private void addJoin1(StringBuilder sb) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       sb.append(&quot;inner join Purchasing.PurchaseOrderLines l on o.PurchaseOrderID = l.PurchaseOrderID &quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   private void addJoin2(StringBuilder sb) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      sb.append(&quot;inner join Purchasing.Suppliers s on s.SupplierID = o.SupplierID&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Let&#x27;s make some assumptions:</p>
<ul>
<li>codebase is tens of thousands files, but query building is local to single file</li>
<li>queries are built with <strong>StringBuilder</strong> but there can be some noise like unrelated <strong>appends</strong></li>
<li>query is &quot;finalized* with passing it to <strong>jdbcTemplate</strong></li>
<li>query building can be nested in helper methods which can further nest the logic</li>
<li>query searching has to be case insensitive</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="approximate-solution">Approximate solution<a href="#approximate-solution" class="hash-link" aria-label="Direct link to Approximate solution" title="Direct link to Approximate solution">â</a></h2>
<p>My logic here is the following. Having a file of the given query is good enough, even having false positives.
So let&#x27;s assume that the file is valid if it has all the query chunks. For example WWRepository1.java is valid
because it has:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SELECT Description, SupplierName, BankAccountName, ValidFrom, ValidTo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>and</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FROM Purchasing.PurchaseOrders o </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>and</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">inner join Purchasing.PurchaseOrderLines l on o.PurchaseOrderID = l.PurchaseOrderID</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>and</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">inner join Purchasing.Suppliers s on s.SupplierID = o.SupplierID</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>A limitation of this approach is that if we have 2 queries in one file, they could intermix and
give a false positive, but let&#x27;s not worry about that for now.</p>
<p>Let&#x27;s write first CodeQL query.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">from </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    File f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">where </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exists(MethodCall e, Expr part |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        e.getFile() = f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        and e.getMethod().hasName(&quot;append&quot;) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        and e.getQualifier().getType().hasName(&quot;StringBuilder&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        and part = e.getArgument(0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        and (part.toString().matches(&quot;%SELECT Description, SupplierName, BankAccountName, ValidFrom, ValidTo%&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    and exists (MethodCall e, Expr part |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        e.getFile() = f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        and e.getMethod().hasName(&quot;append&quot;) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        and e.getQualifier().getType().hasName(&quot;StringBuilder&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        and part = e.getArgument(0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        and part.toString().matches(&quot;%FROM Purchasing.PurchaseOrders%&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     and exists (MethodCall e, Expr part |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        e.getFile() = f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        and e.getMethod().hasName(&quot;append&quot;) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        and e.getQualifier().getType().hasName(&quot;StringBuilder&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        and part = e.getArgument(0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        and part.toString().matches(&quot;%inner join Purchasing.PurchaseOrderLines%&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     and exists (MethodCall e, Expr part |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        e.getFile() = f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        and e.getMethod().hasName(&quot;append&quot;) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        and e.getQualifier().getType().hasName(&quot;StringBuilder&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        and part = e.getArgument(0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        and part.toString().matches(&quot;%inner join Purchasing.Suppliers%&quot;)      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">select f</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And we get one file which is correct. CodeQL is purely declarative that allows to treat AST element like a table in
itself.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  File f</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Find any file in the database.</p>
<p><code>e.getMethod().hasName(&quot;append&quot;)</code> - we are targeting appends</p>
<p><code>e.getQualifier().getType().hasName(&quot;StringBuilder&quot;)</code> - the target type is StringBuilder</p>
<p><code>part = e.getArgument(0)</code> - limit part expression to be first argument of our append</p>
<p><code>part.toString().matches(&quot;%FROM Purchasing.PurchaseOrders%&quot;)</code> - first argument serialized to string has this label</p>
<p>Now that we found something let&#x27;s refine the query to be more accurate.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="exact-solution">Exact solution<a href="#exact-solution" class="hash-link" aria-label="Direct link to Exact solution" title="Direct link to Exact solution">â</a></h2>
<p>So far we used pure AST based queries, but a nice feature of <strong>CodeQL</strong> is that allows to analyze data flow
inside the codebase. It&#x27;s has it&#x27;s limitations though - you can&#x27;t just compute the expression for a method for
example as that would mean running the program. You can however order instructions in codebase in happens-before
relation which is good enough to refine our query.</p>
<p>CodeQL has 2 variants: Local DataFlow and Global DataFlow. It turns out that local variant is presupposed to be
used on simple expressions and does not track variables across method calls. So we will use global option (I have
no idea how long it runs for medium sized projects)</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import semmle.code.java.dataflow.DataFlow</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  module FindQueryConfig implements DataFlow::ConfigSig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    predicate isSource(DataFlow::Node source) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      exists (MethodCall jdbcQuery, MethodCall toString |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            jdbcQuery.getMethod().hasName(&quot;query&quot;) and</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            jdbcQuery.getArgument(0) = toString and </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            toString.getMethod().hasName(&quot;toString&quot;) and</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DataFlow::localFlow(DataFlow::exprNode(source.asExpr()), </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                 DataFlow::exprNode(toString.getQualifier()))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    predicate isSink(DataFlow::Node sink) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       sink.asExpr().(MethodCall).getMethod().hasName(&quot;append&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       and exists (Expr argument |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            argument = sink.asExpr().(MethodCall).getArgument(0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            and (argument.toString().matches(&quot;%SELECT Description, SupplierName, BankAccountName, ValidFrom, ValidTo%&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            or argument.toString().matches(&quot;%FROM Purchasing.PurchaseOrders%&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            or argument.toString().matches(&quot;%inner join Purchasing.PurchaseOrderLines%&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            or argument.toString().matches(&quot;%inner join Purchasing.Suppliers%&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  module FindQuery = DataFlow::Global&lt;FindQueryConfig&gt;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  from DataFlow::Node src, DataFlow::Node sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  where FindQuery::flow(src, sink)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  select src, &quot;This environment variable constructs a URL $@.&quot;, sink, &quot;here&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In essence dataflow is represented as ordered instructions coming from source to sink. There is only
one sink and from it all preceding instructions are considered. Then these 2 variables can be further
matched in query to limit the search.</p>
<p>This query is considering as sink any expression that ultimately lands in <code>jdbc.query</code> as an argument so</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">StringBuilder aside = new StringBuilder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aside.append(&quot;Hello &quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aside.append(&quot;World&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aside.append(&quot;!&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>this won&#x27;t be matched as false positive.</p>
<p>The sink is any append expression that takes familiar labels from the previous part.</p>
<p><code>predicate</code> - this is the function that takes any arguments and returns boolean, it is
designed to offload heavy logic from your main query to selfcontained part</p>
<p><code>exists</code> - it is a subquery that matches if any of the records exists, before the bar <code>|</code>
you write &quot;free variables&quot; and after some condition like in predicate</p>
<p>Then final lines is the flow execution. Little nuisance is that instead of single file it will
give you all code paths to the sinks. But clicking any of the links takes you to the file anyway.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">â</a></h2>
<p>CodeQL is rich and mature tool. I only uncovered the tip of an iceberg for a specific use case.
If you are interested you can:</p>
<ul>
<li>read the documentation or github blog posts</li>
<li>read index of all combinators</li>
<li>read security rules written on top of it</li>
</ul>
<p><strong>Further reading</strong></p>
<ul>
<li><a href="https://github.blog/developer-skills/github/codeql-zero-to-hero-part-1-the-fundamentals-of-static-analysis-for-vulnerability-research/" target="_blank" rel="noopener noreferrer">CodeQL zero to hero: part 1</a></li>
<li><a href="https://github.blog/developer-skills/github/codeql-zero-to-hero-part-2-getting-started-with-codeql/" target="_blank" rel="noopener noreferrer">CodeQL zero to hero: part 2</a></li>
<li><a href="https://github.blog/security/vulnerability-research/codeql-zero-to-hero-part-3-security-research-with-codeql/" target="_blank" rel="noopener noreferrer">CodeQL zero to hero: part 3</a></li>
</ul></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/codeql">codeql</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/java">java</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/sql">sql</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2025-03-9.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/2025/03/3/"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Wring simple parser with Megaparsec in Haskell</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#codeql-setup" class="table-of-contents__link toc-highlight">CodeQL setup</a></li><li><a href="#the-challenge" class="table-of-contents__link toc-highlight">The challenge</a></li><li><a href="#approximate-solution" class="table-of-contents__link toc-highlight">Approximate solution</a></li><li><a href="#exact-solution" class="table-of-contents__link toc-highlight">Exact solution</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container container-fluid"></div></footer></div>
</body>
</html>