<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="UTF-8">
    <title>Dominik Gawlik's Personal Page</title>
    <title>Dominik Gawlik's Personal Page</title>
   <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&amp;family=Noto+Serif:ital,wght@0,100..900;1,100..900&amp;display=swap" rel="stylesheet">
     <link href="/css/code_theme.css" rel="stylesheet">
    <style>
        a {
            color: black;
            cursor: pointer;
        }
        .date {
            font-size: 1.2rem;
            color: gray;
            font-style: italics;
        }
        .topic {
            font-size: 1.6rem;
            color: black;
            font-style: underline;
        }
        li {
            list-style-type: '>>';
            padding-inline-start: 1ch;
        }
        h1 {
            display: inline;
            line-height: 20px;
        }Medium
        body {
            font-size: 1.3rem;
        }
    </style>
  </head>
  <body style="margin:0; padding:0; background-color: #fafafa; font-family: 'Libre Baskerville', serif;">
    <div style="float: left; position: fixed  ; 5rem; height: 100vh; width: 25%; background: url('/assets/eberhart.jpg'); background-size: cover;">
        <div style="position: relative; top: 5rem; left: 20px;" ;="">
             <h1><img style="display: inline; height: 3rem;" src="/assets/D.png">ominik <br><br> <img style="display: inline; height: 2.rem;" src="/assets/G.png">awlik</h1>

            <br>
            <br>
            <br>    
              <br>
            <br>
            <br>     
                 <br>
            <br>
            
        
            <h1>
            <a href="https://github.com/dgawlik"><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 30 30" width="4rem" height="4rem" class="_icon_35jzz_22"><path d="M15,3C8.373,3,3,8.373,3,15c0,5.623,3.872,10.328,9.092,11.63C12.036,26.468,12,26.28,12,26.047v-2.051 c-0.487,0-1.303,0-1.508,0c-0.821,0-1.551-0.353-1.905-1.009c-0.393-0.729-0.461-1.844-1.435-2.526 c-0.289-0.227-0.069-0.486,0.264-0.451c0.615,0.174,1.125,0.596,1.605,1.222c0.478,0.627,0.703,0.769,1.596,0.769 c0.433,0,1.081-0.025,1.691-0.121c0.328-0.833,0.895-1.6,1.588-1.962c-3.996-0.411-5.903-2.399-5.903-5.098 c0-1.162,0.495-2.286,1.336-3.233C9.053,10.647,8.706,8.73,9.435,8c1.798,0,2.885,1.166,3.146,1.481C13.477,9.174,14.461,9,15.495,9 c1.036,0,2.024,0.174,2.922,0.483C18.675,9.17,19.763,8,21.565,8c0.732,0.731,0.381,2.656,0.102,3.594 c0.836,0.945,1.328,2.066,1.328,3.226c0,2.697-1.904,4.684-5.894,5.097C18.199,20.49,19,22.1,19,23.313v2.734 c0,0.104-0.023,0.179-0.035,0.268C23.641,24.676,27,20.236,27,15C27,8.373,21.627,3,15,3z"></path></svg></a>
            </h1>
            <h1>
            <a href="https://medium.com/@dominik.gawlik1"><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" width="4rem" height="4rem" class="_icon_35jzz_22"><path d="M7 6A7 7 0 107 20 7 7 0 107 6zM18 6.5A3 6.5 0 1018 19.5 3 6.5 0 1018 6.5zM23 8A1 5 0 1023 18 1 5 0 1023 8z"></path></svg></a>
            </h1>
            <h1>
            <a href="https://www.pexels.com/@dominik-gawlik-267672553/"><svg width="4rem" height="4rem" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="_icon_35jzz_22"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 5C12.7111 5 13.3875 5.14845 14 5.41604C15.7659 6.1876 17 7.94968 17 10C17 12.0503 15.7659 13.8124 14 14.584C13.3875 14.8516 12.7111 15 12 15V19H6V5H12ZM8 7V17H10V13H12L12.0032 12.9988C13.6427 13.0303 15.0746 11.6934 15.0443 9.95469L15.0375 9.56529C15.0121 8.10183 13.7882 6.94549 12.3257 7.00299L12.0203 7.00762L12 7H8Z" fill="#000000"></path></svg></a>
            </h1><h1>
            <a href="https://www.instagram.com/dominik.gawlik1/"><svg width="4rem" height="4rem" viewbox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="_icon_35jzz_22"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 7C9.23858 7 7 9.23858 7 12C7 14.7614 9.23858 17 12 17C14.7614 17 17 14.7614 17 12C17 9.23858 14.7614 7 12 7ZM9 12C9 13.6569 10.3431 15 12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12Z" fill="#000000"></path><path d="M18 5C17.4477 5 17 5.44772 17 6C17 6.55228 17.4477 7 18 7C18.5523 7 19 6.55228 19 6C19 5.44772 18.5523 5 18 5Z" fill="#000000"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M5 1C2.79086 1 1 2.79086 1 5V19C1 21.2091 2.79086 23 5 23H19C21.2091 23 23 21.2091 23 19V5C23 2.79086 21.2091 1 19 1H5ZM19 3H5C3.89543 3 3 3.89543 3 5V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V5C21 3.89543 20.1046 3 19 3Z" fill="#000000"></path></svg></a>
            </h1>
        
        </div>

       
    </div>
    <div style="margin-left: 30rem; padding: 5rem; width: 60%; background-color: #fafafa;">
        <h1>Reflections after writing simple Spring Boot library</h1>
<blockquote>
<p>Sometimes learning from adversity is better than trying to avoid it.<br> Taking it into
careful consideration provides valuable lessons that will support you in the future.</p>
</blockquote>
<p>I appreciate my job for one particular thing. That is, it provides steady steam of difficult
problems that challenge my intellect. Recently I tried to wrap my head around problem how
to write tests for semi-large Spring Boot codebase and refactor it (with no tests whatsoever).</p>
<p>I started from the assumption that <strong>when you don't have any legacy tests at hand first you write them</strong>. How can you know you don't break functionality without running the tests? But the code was very unfriendly and writing them would require writing mocks.</p>
<p>So I thought - why not automate stuff a little bit:</p>
<ul>
<li>instrument given beans with reflection</li>
<li>dump args and results to json</li>
<li>load json directly in tests instead of writing mocks in plain Java</li>
</ul>
<h3>The problem</h3>
<p>Main problem is that there are absolutely no tests. All testing is done by business. What a terrible waste of time... Each time something changes they click their way through all over again.</p>
<p>So I thought I will take <em>snapshot</em> of current state of things and secure some tests in the backend. But there is some many API methods! And each has nested call to service and service calls repository.</p>
<p>I would write aspects no problem, but repositories are as you recall interfaces for which
the classes are generated by Spring. And to add to that I want to move fast and writing the
Advices takes time.</p>
<p>I have come up with instrumenting the selected beans, but those beans can autowire another
instrumented beans. So some mechanism has to be devised to order the instrumentation to do it
from the bottom-most to the top.</p>
<h3>Approach</h3>
<p>So I have both "special" interfaces of repositories and plain beans annotated as components. Then you have to cater for both of the cases. For the interfaces I generated JDK dynamic proxies. For classes (as it happens they don't implement any interface) I used <strong>ByteBuddy</strong> instrumentation library to subclass them and load them with default classloader.</p>
<p>And I have instrumented beans. Now I unload the old beans and switch them to proxes. For that I used <strong>BeanFactory</strong> which I took from the <strong>ApplicationContext</strong> with some class casting. But that is not all beacuse you still have to <strong>autowire</strong> all affected beans.</p>
<p>First iteration of autowiring was very wasteful and boiled down to realoading everything. Then I came to the conclusion to build the <strong>dependency graph</strong> and updated only the nodes of the graph in reverse order. Spring BeanFactory has both methods for finding bean dependencies and dependants so it was pretty easy. One catch is that you have to actually autowire not the bean itself but the subclassed proxy. After that everything worked as charm.</p>
<p>If you are interested you can download the lib <a href="https://github.com/dgawlik/inspector">here</a>.</p>
<h3>Reflections</h3>
<p>After writing the lib and being exposed to the project at work I have some thoughts.</p>
<p>First if you write <strong>Autoconfig lib</strong> to be used by other Spring components <strong>you absolutely can't</strong> poison the application context with unncessary stuff. If you you put <strong>bootstrap.yaml</strong> in your library it will float on forever and take predecence and collide with stuff already defined. Spring treats the same multiple bootstraps and in case of name collision the order is random. And if you specify it in <strong>config/-</strong> directory it will actually take predecence over anything else.</p>
<p>Moreover you should not define any components picked up by component scanning as these can clash with other things defined. Just confine everything inside the <strong>@AutoConfiguration</strong> annotated class with the exception of loading necessary stuff with <strong>@Import</strong>.</p>
<p>Likewise you should not include starters in your library because they will for sure accumulate for several libs. Just use specific non-umbrella deps even better include your own jars.</p>
<p>IF you have crosscutting concerns like authentication, you should not use internals outside the pointcuts. So for example you have authentication fetching the token before the feign call. Then using static class for caching the token and pulling it from the business logic is a big mistake.</p>
<p>Finally you should have mock database and the whole thing would not be needed. I would just happily write e2e tests then.</p>
<h3>Conclusion</h3>
<p>What will be of my little library is yet to be defined. However I learned about some best practices for writing spring boot libs and learned some lessons not to repeat over again. You I am happily sharing it to you by this article.</p>

    <div>
  
</div></div></body></html>